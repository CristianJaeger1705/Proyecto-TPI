{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Perfil - Laburo SV{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-pencil"></i> Editar mi Perfil
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Informaci√≥n Personal -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-person"></i> Informaci√≥n Personal
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.telefono.id_for_label }}" class="form-label">
                                        {{ form.telefono.label }}
                                    </label>
                                    {{ form.telefono }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">
                                        {{ form.fecha_nacimiento.label }}
                                    </label>
                                    {{ form.fecha_nacimiento }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.departamento.id_for_label }}" class="form-label">
                                        {{ form.departamento.label }}
                                    </label>
                                    {{ form.departamento }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.municipio.id_for_label }}" class="form-label">
                                        {{ form.municipio.label }}
                                    </label>
                                    {{ form.municipio }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.foto_perfil.id_for_label }}" class="form-label">
                                        {{ form.foto_perfil.label }}
                                    </label>
                                    {{ form.foto_perfil }}
                                    {% if perfil.foto_perfil %}
                                        <small class="form-text text-muted">Foto actual: <a href="{{ perfil.foto_perfil.url }}" target="_blank">Ver</a></small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.direccion.id_for_label }}" class="form-label">
                                    {{ form.direccion.label }}
                                </label>
                                {{ form.direccion }}
                            </div>
                        </div>

                        <!-- Informaci√≥n Profesional -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-briefcase"></i> Informaci√≥n Profesional
                            </h5>
                            <div class="mb-3">
                                <label for="{{ form.profesion.id_for_label }}" class="form-label">
                                    {{ form.profesion.label }}
                                </label>
                                {{ form.profesion }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.biografia.id_for_label }}" class="form-label">
                                    {{ form.biografia.label }}
                                </label>
                                {{ form.biografia }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.habilidades.id_for_label }}" class="form-label">
                                    {{ form.habilidades.label }}
                                </label>
                                {{ form.habilidades }}
                                <small class="form-text text-muted">{{ form.habilidades.help_text }}</small>
                            </div>
                            
                            <!-- M√≥dulo de Experiencias Laborales -->
                            <div class="mb-3">
                                <label class="form-label">Experiencia Laboral</label>
                                <div class="card border-primary">
                                    <div class="card-body">
                                        {% if perfil.experiencias.all %}
                                            <div class="list-group list-group-flush">
                                                {% for exp in perfil.experiencias.all %}
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="bi bi-briefcase text-primary"></i>
                                                            <strong>{{ exp.titulo_cargo }}</strong>
                                                            <small class="text-muted ms-2">¬∑ {{ exp.empresa }}</small>
                                                        </div>
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'usuarios:editar_experiencia' exp.id %}?next={% url 'usuarios:editar_perfil_candidato' %}" 
                                                               class="btn btn-outline-primary" 
                                                               title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{% url 'usuarios:eliminar_experiencia' exp.id %}?next={% url 'usuarios:editar_perfil_candidato' %}" 
                                                               class="btn btn-outline-danger" 
                                                               title="Eliminar">
                                                                <i class="bi bi-trash"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p class="text-muted text-center mb-0">No has agregado experiencias laborales a√∫n.</p>
                                        {% endif %}
                                        
                                        <div class="text-center mt-3">
                                            <a href="{% url 'usuarios:agregar_experiencia' %}?next={% url 'usuarios:editar_perfil_candidato' %}" class="btn btn-sm btn-primary">
                                                <i class="bi bi-plus-circle"></i> Agregar Experiencia
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Educaci√≥n -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-mortarboard"></i> Educaci√≥n
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.nivel_educacion.id_for_label }}" class="form-label">
                                        {{ form.nivel_educacion.label }}
                                    </label>
                                    {{ form.nivel_educacion }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.institucion_educativa.id_for_label }}" class="form-label">
                                        {{ form.institucion_educativa.label }}
                                    </label>
                                    {{ form.institucion_educativa }}
                                </div>
                            </div>
                        </div>

                        <!-- Archivos -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-file-earmark"></i> Archivos
                            </h5>
                            <div class="mb-3">
                                <label for="{{ form.cv.id_for_label }}" class="form-label">
                                    {{ form.cv.label }}
                                </label>
                                {{ form.cv }}
                                {% if perfil.cv %}
                                    <small class="form-text text-muted">CV actual: <a href="{{ perfil.cv.url }}" target="_blank">Ver CV</a></small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Preferencias -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-gear"></i> Preferencias Laborales
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.disponibilidad.id_for_label }}" class="form-label">
                                        {{ form.disponibilidad.label }}
                                    </label>
                                    {{ form.disponibilidad }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.salario_esperado.id_for_label }}" class="form-label">
                                        {{ form.salario_esperado.label }}
                                    </label>
                                    {{ form.salario_esperado }}
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'usuarios:mi_perfil_candidato' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Volver al Perfil
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const STORAGE_KEY = 'editar_perfil_candidato_data';
    
    // ============================================
    // GUARDAR Y RESTAURAR DATOS DEL FORMULARIO
    // ============================================
    
    // Funci√≥n para guardar todos los campos del formulario
    function guardarFormulario() {
        const formData = {};
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            if (input.name && input.type !== 'file' && input.name !== 'csrfmiddlewaretoken') {
                if (input.type === 'checkbox') {
                    formData[input.name] = input.checked;
                } else {
                    formData[input.name] = input.value;
                }
            }
        });
        
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
        console.log('üìù Formulario guardado en sessionStorage');
    }
    
    // Funci√≥n para restaurar los campos del formulario
    function restaurarFormulario() {
        const savedData = sessionStorage.getItem(STORAGE_KEY);
        if (!savedData) return;
        
        const formData = JSON.parse(savedData);
        
        // Esperar un momento para que el select de municipios se cree
        setTimeout(() => {
            Object.keys(formData).forEach(name => {
                const input = form.querySelector(`[name="${name}"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = formData[name];
                    } else {
                        input.value = formData[name];
                    }
                }
            });
            console.log('‚úÖ Formulario restaurado desde sessionStorage');
        }, 500);
    }
    
    // Limpiar datos guardados al enviar el formulario exitosamente
    form.addEventListener('submit', function() {
        sessionStorage.removeItem(STORAGE_KEY);
    });
    
    // Guardar antes de navegar a agregar/editar experiencia
    document.querySelectorAll('a[href*="experiencia"]').forEach(link => {
        link.addEventListener('click', function(e) {
            guardarFormulario();
        });
    });
    
    // Restaurar datos si venimos de agregar/editar experiencia
    if (document.referrer.includes('experiencia')) {
        restaurarFormulario();
    }
    
    // ============================================
    // FILTRADO DIN√ÅMICO DE MUNICIPIOS
    // ============================================
    
    const departamentoSelect = document.getElementById('id_departamento');
    const municipioInput = document.getElementById('id_municipio');
    
    if (departamentoSelect && municipioInput) {
        // Guardar el valor original del municipio (para edici√≥n)
        const municipioOriginal = municipioInput.value;
        
        // Tambi√©n revisar si hay valor guardado en sessionStorage
        const savedData = sessionStorage.getItem(STORAGE_KEY);
        let municipioGuardado = '';
        if (savedData) {
            const formData = JSON.parse(savedData);
            municipioGuardado = formData.municipio || '';
        }
        
        // Convertir input a select
        const municipioSelect = document.createElement('select');
        municipioSelect.id = 'id_municipio';
        municipioSelect.name = 'municipio';
        municipioSelect.className = municipioInput.className;
        municipioSelect.required = municipioInput.required;
        
        // Reemplazar input por select
        municipioInput.parentNode.replaceChild(municipioSelect, municipioInput);
        
        function cargarMunicipios(departamento, valorSeleccionado = '') {
            if (!departamento) {
                municipioSelect.innerHTML = '<option value="">Primero selecciona un departamento</option>';
                return;
            }
            
            // Hacer petici√≥n AJAX para obtener municipios
            fetch(`/usuarios/api/municipios/${departamento}/`)
                .then(response => response.json())
                .then(data => {
                    municipioSelect.innerHTML = '<option value="">Selecciona un municipio</option>';
                    data.municipios.forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio;
                        option.textContent = municipio;
                        if (municipio === valorSeleccionado) {
                            option.selected = true;
                        }
                        municipioSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar municipios:', error);
                    municipioSelect.innerHTML = '<option value="">Error al cargar municipios</option>';
                });
        }
        
        // Evento al cambiar departamento
        departamentoSelect.addEventListener('change', function() {
            cargarMunicipios(this.value);
        });
        
        // Cargar municipios al inicio
        if (departamentoSelect.value) {
            // Priorizar: municipio guardado > municipio original
            const valorMunicipio = municipioGuardado || municipioOriginal;
            cargarMunicipios(departamentoSelect.value, valorMunicipio);
        }
    }
});
</script>
{% endblock %}
